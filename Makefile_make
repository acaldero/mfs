
#
# Const
#

CC=mpic++
AR=ar
#CFLAGS=-w -g -O2 -Wall -I/usr/local/include/ -I./ -I./include -DHAVE_GDBM_H -DHAVE_HIREDIS_H -DDEBUG 
 CFLAGS=-w -g -O2 -Wall -I/usr/local/include/ -I./ -I./include -DHAVE_GDBM_H -DHAVE_HIREDIS_H
LDFLAGS=-lpthread  -lhiredis  -lgdbm  -lyaml

OBJ_DIR=src
BIN_DIR=bin
LIB_DIR=lib
BIN_FILES=$(BIN_DIR)/mfs_server
LIB_FILES=$(LIB_DIR)/mfs_client.a
OBJ_FILES=src/mfs_client_api.o   src/mfs_client_stub.o       src/mfs_server_stub.o \
	  src/mfs_protocol.o \
	  src/mfs_workers.o      src/mfs_workers_pool.o      src/mfs_workers_onrequest.o \
	  src/mfs_comm.o         src/mfs_comm_mpi.o          src/mfs_comm_socket.o \
	  src/mfs_files.o        src/mfs_files_posix.o       src/mfs_files_mpi.o    src/mfs_files_redis.o \
	  src/mfs_directories.o  src/mfs_directories_posix.o                        src/mfs_directories_redis.o \
          src/mfs_dbm.o          src/mfs_dbm_gdbm.o \
	  src/mfs_ns.o \
	  src/mfs_params.o       src/mfs_yaml.o              src/mfs_descriptors.o  src/mfs_lib.o


#
# Rules
#

all: begin $(BIN_FILES) $(LIB_FILES) end
.PHONY: all clean begin end

begin:
	@echo ""
	@echo " MPI_FS"
	@echo " ~~~~~~"
	@echo ""
	@echo " Compile mfs_client.a and mfs_server"
end:
	@echo " Done"

lib/mfs_client.a:                  $(OBJ_FILES)
	$(AR) rcs $@ $^

bin/mfs_server:   src/mfs_server.o $(OBJ_FILES)
	$(CC) $^  $(LDFLAGS)  -o $@

$(OBJ_DIR)/%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

clean:
	@echo " Remove cmake stuff..."
	rm -fr CMakeCache.txt
	rm -fr CMakeFiles/
	rm -fr cmake_install.cmake
	@echo " Remove objects, binaries and libraries..."
	rm -f  src/*.o
	rm -f  $(BIN_FILES) 
	rm -f  $(LIB_FILES)
	@echo " Done"

